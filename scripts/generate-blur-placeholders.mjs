/**
 * Generates tiny base64 blur placeholders for all images in public/images/
 * and optionally converts them to WebP for even smaller file sizes.
 *
 * Run: node scripts/generate-blur-placeholders.mjs
 * Output: lib/blur-placeholders.ts
 */
import sharp from 'sharp';
import { readdir, stat, writeFile, mkdir } from 'fs/promises';
import { join, extname, basename, relative } from 'path';

const IMG_DIR = 'public/images';
const OUTPUT_FILE = 'lib/blur-placeholders.ts';

async function getAllImages(dir) {
  const entries = await readdir(dir, { withFileTypes: true });
  const files = [];
  for (const entry of entries) {
    const fullPath = join(dir, entry.name);
    if (entry.isDirectory()) {
      files.push(...await getAllImages(fullPath));
    } else {
      const ext = extname(entry.name).toLowerCase();
      if (['.jpg', '.jpeg', '.png', '.webp'].includes(ext)) {
        files.push(fullPath);
      }
    }
  }
  return files;
}

async function generateBlurDataURL(filePath) {
  // Create a tiny 16px wide blurred version and convert to base64
  const buffer = await sharp(filePath)
    .resize(16, undefined, { withoutEnlargement: true })
    .blur(2)
    .jpeg({ quality: 40 })
    .toBuffer();

  return `data:image/jpeg;base64,${buffer.toString('base64')}`;
}

async function main() {
  console.log('Scanning images in', IMG_DIR, '...\n');
  const images = await getAllImages(IMG_DIR);
  console.log(`Found ${images.length} images\n`);

  const placeholders = {};

  for (const img of images) {
    try {
      // Key: the public path (e.g. /images/hero.png)
      const publicPath = '/' + relative('public', img).replace(/\\/g, '/');
      const blurDataURL = await generateBlurDataURL(img);
      placeholders[publicPath] = blurDataURL;
      console.log(`  ✓ ${basename(img)}`);
    } catch (err) {
      console.error(`  ✗ ${basename(img)}: ${err.message}`);
    }
  }

  // Ensure lib/ directory exists
  await mkdir('lib', { recursive: true });

  // Write TypeScript map
  const tsContent = `// Auto-generated by scripts/generate-blur-placeholders.mjs
// Do not edit manually. Re-run: npm run generate-blur

export const blurPlaceholders: Record<string, string> = ${JSON.stringify(placeholders, null, 2)};

/**
 * Get blur placeholder for an image path.
 * Returns a tiny base64 data URL for use as blurDataURL prop.
 */
export function getBlur(src: string): string {
  // Try exact match first, then case-insensitive
  if (blurPlaceholders[src]) return blurPlaceholders[src];
  const lower = src.toLowerCase();
  const key = Object.keys(blurPlaceholders).find(k => k.toLowerCase() === lower);
  return key ? blurPlaceholders[key] : '';
}
`;

  await writeFile(OUTPUT_FILE, tsContent, 'utf-8');
  console.log(`\n✅ Generated ${Object.keys(placeholders).length} blur placeholders → ${OUTPUT_FILE}`);
}

main().catch(console.error);
